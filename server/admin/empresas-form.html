<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Empresa - Admin Portal do Romeiro</title>
  <style>
    :root {
      --primary: #b22226;
      --primary-dark: #8b1a1d;
      --sidebar-bg: #1a1a2e;
      --text-light: #e5e7eb;
      --text-muted: #9ca3af;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      color: var(--text-light);
      position: fixed;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
    }
    .sidebar-header h1 {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    .sidebar-header p {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .sidebar nav {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0;
    }
    .nav-section {
      padding: 0 16px;
      margin-bottom: 16px;
    }
    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 8px;
      margin-bottom: 8px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--text-muted);
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 4px;
      transition: all 0.2s;
    }
    .nav-item:hover { background: #16213e; color: white; }
    .nav-item.active { background: var(--primary); color: white; }
    .sidebar-footer {
      margin-top: auto;
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
    }
    .logout-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      color: #ef4444;
      text-decoration: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .logout-btn:hover { background: rgba(239, 68, 68, 0.1); }
    .main {
      flex: 1;
      margin-left: 260px;
      padding: 32px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .header h2 { font-size: 24px; color: #1f2937; }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .form-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 32px;
    }
    .form-section {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    .form-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .form-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 16px;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .form-row-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group.full-width {
      grid-column: span 2;
    }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(178, 34, 38, 0.1);
    }
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .alert-error { background: #fee2e2; color: #b91c1c; }
    .alert-success { background: #d1fae5; color: #059669; }
    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .image-preview {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      object-fit: cover;
      margin-top: 8px;
      display: none;
    }
    .image-preview.visible { display: block; }
    .upload-area {
      border: 2px dashed #d1d5db;
      border-radius: 8px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s;
      background: #fafafa;
    }
    .upload-area:hover {
      border-color: var(--primary);
      background: #fff5f5;
    }
    .upload-area.dragover {
      border-color: var(--primary);
      background: #fff5f5;
    }
    .upload-area input[type="file"] {
      display: none;
    }
    .upload-icon {
      width: 48px;
      height: 48px;
      margin: 0 auto 12px;
      color: #9ca3af;
    }
    .upload-text {
      font-size: 14px;
      color: #6b7280;
    }
    .upload-text strong {
      color: var(--primary);
    }
    .image-preview-container {
      position: relative;
      display: inline-block;
      margin-top: 12px;
    }
    .image-preview-container img {
      width: 120px;
      height: 120px;
      border-radius: 8px;
      object-fit: cover;
    }
    .image-preview-container .remove-btn {
      position: absolute;
      top: -8px;
      right: -8px;
      width: 24px;
      height: 24px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 14px;
      font-weight: bold;
    }
    .gallery-container {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      margin-top: 12px;
    }
    .gallery-item {
      position: relative;
    }
    .gallery-item img {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      object-fit: cover;
    }
    .gallery-item .remove-btn {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 20px;
      height: 20px;
      background: #ef4444;
      color: white;
      border: none;
      border-radius: 50%;
      cursor: pointer;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .uploading {
      opacity: 0.6;
      pointer-events: none;
    }
    .upload-progress {
      font-size: 12px;
      color: var(--primary);
      margin-top: 8px;
    }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>Portal do Romeiro</h1>
      <p>Painel Administrativo</p>
    </div>
    <nav>
      <div class="nav-section">
        <div class="nav-section-title">Principal</div>
        <a href="/admin/dashboard" class="nav-item">Dashboard</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Conteudo</div>
        <a href="/admin/noticias" class="nav-item">Noticias</a>
        <a href="/admin/videos" class="nav-item">Videos</a>
        <a href="/admin/paginas" class="nav-item">Paginas</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Turismo</div>
        <a href="/admin/pontos-turisticos" class="nav-item">Pontos Turisticos</a>
        <a href="/admin/empresas" class="nav-item active">Guia Comercial</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Romeiro</div>
        <a href="/admin/telefones" class="nav-item">Telefones Uteis</a>
        <a href="/admin/dicas" class="nav-item">Dicas do Romeiro</a>
        <a href="/admin/servicos" class="nav-item">Servicos</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Sistema</div>
        <a href="/admin/usuarios" class="nav-item">Usuarios</a>
      </div>
    </nav>
    <div class="sidebar-footer">
      <a href="#" class="logout-btn" onclick="logout()">Sair</a>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <h2 id="pageTitle">Nova Empresa</h2>
    </div>

    <div class="form-container">
      <div id="alert" class="alert" style="display: none;"></div>

      <form id="businessForm">
        <div class="form-section">
          <h3 class="form-section-title">Informacoes Basicas</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="name">Nome da Empresa *</label>
              <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
              <label for="categoryId">Categoria *</label>
              <select id="categoryId" name="categoryId" required onchange="updateCategoryName()">
                <option value="">Selecione...</option>
                <option value="onde-comer" data-name="Restaurante">Onde Comer</option>
                <option value="onde-ficar" data-name="Hospedagem">Onde Ficar</option>
                <option value="onde-comprar" data-name="Loja">Onde Comprar</option>
                <option value="construcao" data-name="Construcao">Construcao e Reforma</option>
                <option value="diversao" data-name="Lazer">Diversao e Lazer</option>
                <option value="carro" data-name="Automotivo">Para seu Carro</option>
                <option value="moto" data-name="Moto">Para sua Moto</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="category">Tipo de Negocio *</label>
              <input type="text" id="category" name="category" placeholder="Ex: Restaurante, Pousada, Loja..." required>
            </div>
            <div class="form-group">
              <label for="priceRange">Faixa de Preco</label>
              <select id="priceRange" name="priceRange">
                <option value="">Selecione...</option>
                <option value="$">$ - Economico</option>
                <option value="$$">$$ - Moderado</option>
                <option value="$$$">$$$ - Caro</option>
                <option value="$$$$">$$$$ - Luxo</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="shortDescription">Descricao Curta</label>
            <input type="text" id="shortDescription" name="shortDescription" placeholder="Breve descricao para exibir na listagem">
          </div>
          <div class="form-group">
            <label for="description">Descricao Completa</label>
            <textarea id="description" name="description" placeholder="Descricao detalhada da empresa..."></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Imagens</h3>
          <div class="form-row">
            <div class="form-group">
              <label>Logo da Empresa</label>
              <div class="upload-area" id="logoUploadArea" onclick="document.getElementById('logoFile').click()">
                <input type="file" id="logoFile" accept="image/*" onchange="uploadSingleImage('logoFile', 'logoPreviewContainer', 'logoUrl')">
                <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <p class="upload-text"><strong>Clique para enviar</strong> ou arraste uma imagem</p>
              </div>
              <input type="hidden" id="logoUrl" name="logoUrl">
              <div id="logoPreviewContainer" class="image-preview-container" style="display: none;">
                <img id="logoPreviewImg" src="" alt="Logo">
                <button type="button" class="remove-btn" onclick="removeImage('logoUrl', 'logoPreviewContainer', 'logoUploadArea')">&times;</button>
              </div>
            </div>
            <div class="form-group">
              <label>Imagem de Capa</label>
              <div class="upload-area" id="coverUploadArea" onclick="document.getElementById('coverFile').click()">
                <input type="file" id="coverFile" accept="image/*" onchange="uploadSingleImage('coverFile', 'coverPreviewContainer', 'coverUrl')">
                <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
                <p class="upload-text"><strong>Clique para enviar</strong> ou arraste uma imagem</p>
              </div>
              <input type="hidden" id="coverUrl" name="coverUrl">
              <div id="coverPreviewContainer" class="image-preview-container" style="display: none;">
                <img id="coverPreviewImg" src="" alt="Capa">
                <button type="button" class="remove-btn" onclick="removeImage('coverUrl', 'coverPreviewContainer', 'coverUploadArea')">&times;</button>
              </div>
            </div>
          </div>
          <div class="form-group">
            <label>Galeria de Fotos</label>
            <div class="upload-area" id="galleryUploadArea" onclick="document.getElementById('galleryFiles').click()">
              <input type="file" id="galleryFiles" accept="image/*" multiple onchange="uploadGalleryImages()">
              <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
              <p class="upload-text"><strong>Clique para enviar</strong> ou arraste multiplas imagens</p>
            </div>
            <input type="hidden" id="gallery" name="gallery">
            <div id="galleryPreviewContainer" class="gallery-container"></div>
            <p class="help-text">Voce pode adicionar ate 10 fotos na galeria</p>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Endereco e Localizacao</h3>
          <div class="form-group">
            <label for="address">Endereco</label>
            <input type="text" id="address" name="address" placeholder="Rua, numero...">
          </div>
          <div class="form-row form-row-3">
            <div class="form-group">
              <label for="neighborhood">Bairro</label>
              <input type="text" id="neighborhood" name="neighborhood">
            </div>
            <div class="form-group">
              <label for="city">Cidade</label>
              <input type="text" id="city" name="city" value="Trindade">
            </div>
            <div class="form-group">
              <label for="hours">Horario de Funcionamento</label>
              <input type="text" id="hours" name="hours" placeholder="Ex: Seg-Sex: 8h-18h">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="latitude">Latitude</label>
              <input type="text" id="latitude" name="latitude" placeholder="-16.6499">
            </div>
            <div class="form-group">
              <label for="longitude">Longitude</label>
              <input type="text" id="longitude" name="longitude" placeholder="-49.4897">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Contato e Redes Sociais</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="phone">Telefone</label>
              <input type="tel" id="phone" name="phone" placeholder="(62) 3333-1234">
            </div>
            <div class="form-group">
              <label for="whatsapp">WhatsApp</label>
              <input type="text" id="whatsapp" name="whatsapp" placeholder="5562999991234">
              <p class="help-text">Numero completo com codigo do pais, sem espacos ou caracteres</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="website">Website</label>
              <input type="url" id="website" name="website" placeholder="https://...">
            </div>
            <div class="form-group">
              <label for="instagram">Instagram</label>
              <input type="text" id="instagram" name="instagram" placeholder="@usuario">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="facebook">Facebook</label>
              <input type="text" id="facebook" name="facebook" placeholder="nomedapagina">
            </div>
            <div class="form-group">
              <label for="deliveryUrl">Link do Delivery</label>
              <input type="url" id="deliveryUrl" name="deliveryUrl" placeholder="https://ifood.com.br/...">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Avaliacao</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="rating">Nota (0-5)</label>
              <input type="number" id="rating" name="rating" min="0" max="5" step="0.1" placeholder="4.5">
            </div>
            <div class="form-group">
              <label for="reviews">Numero de Avaliacoes</label>
              <input type="number" id="reviews" name="reviews" min="0" placeholder="0">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Opcoes</h3>
          <div class="form-row">
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="published" name="published" checked>
                <label for="published">Publicado</label>
              </div>
            </div>
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="featured" name="featured">
                <label for="featured">Empresa em Destaque</label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="delivery" name="delivery">
              <label for="delivery">Possui Delivery</label>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <a href="/admin/empresas" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary" id="submitBtn">Salvar</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    let editId = null;
    const pathParts = window.location.pathname.split('/');
    if (pathParts.includes('editar') && pathParts[pathParts.length - 1]) {
      editId = pathParts[pathParts.length - 1];
      document.getElementById('pageTitle').textContent = 'Editar Empresa';
      loadBusiness(editId);
    }

    async function loadBusiness(id) {
      try {
        const response = await fetch(`/admin/api/businesses/${id}`);
        if (!response.ok) throw new Error('Empresa nao encontrada');
        const data = await response.json();
        const b = data.business;

        document.getElementById('name').value = b.name || '';
        document.getElementById('categoryId').value = b.categoryId || '';
        document.getElementById('category').value = b.category || '';
        document.getElementById('shortDescription').value = b.shortDescription || '';
        document.getElementById('description').value = b.description || '';
        document.getElementById('address').value = b.address || '';
        document.getElementById('neighborhood').value = b.neighborhood || '';
        document.getElementById('city').value = b.city || '';
        document.getElementById('hours').value = b.hours || '';
        document.getElementById('latitude').value = b.latitude || '';
        document.getElementById('longitude').value = b.longitude || '';
        document.getElementById('phone').value = b.phone || '';
        document.getElementById('whatsapp').value = b.whatsapp || '';
        document.getElementById('website').value = b.website || '';
        document.getElementById('instagram').value = b.instagram || '';
        document.getElementById('facebook').value = b.facebook || '';
        document.getElementById('deliveryUrl').value = b.deliveryUrl || '';
        document.getElementById('priceRange').value = b.priceRange || '';
        document.getElementById('rating').value = b.rating || '';
        document.getElementById('reviews').value = b.reviews || 0;
        document.getElementById('published').checked = b.published !== false;
        document.getElementById('featured').checked = b.featured === true;
        document.getElementById('delivery').checked = b.delivery === true;

        if (b.logoUrl) {
          document.getElementById('logoUrl').value = b.logoUrl;
          showImagePreview('logoPreviewContainer', 'logoPreviewImg', 'logoUploadArea', b.logoUrl);
        }
        if (b.coverUrl) {
          document.getElementById('coverUrl').value = b.coverUrl;
          showImagePreview('coverPreviewContainer', 'coverPreviewImg', 'coverUploadArea', b.coverUrl);
        }
        if (b.gallery) {
          document.getElementById('gallery').value = b.gallery;
          loadGalleryPreviews(b.gallery);
        }
      } catch (error) {
        showAlert('Erro ao carregar empresa: ' + error.message, 'error');
      }
    }

    function updateCategoryName() {
      const select = document.getElementById('categoryId');
      const selected = select.options[select.selectedIndex];
      const categoryInput = document.getElementById('category');
      if (selected && selected.dataset.name && !categoryInput.value) {
        categoryInput.value = selected.dataset.name;
      }
    }

    function showImagePreview(containerId, imgId, uploadAreaId, url) {
      const container = document.getElementById(containerId);
      const img = document.getElementById(imgId);
      const uploadArea = document.getElementById(uploadAreaId);
      img.src = url;
      container.style.display = 'inline-block';
      uploadArea.style.display = 'none';
    }

    function removeImage(hiddenInputId, containerId, uploadAreaId) {
      document.getElementById(hiddenInputId).value = '';
      document.getElementById(containerId).style.display = 'none';
      document.getElementById(uploadAreaId).style.display = 'block';
    }

    async function uploadSingleImage(fileInputId, containerId, hiddenInputId) {
      const fileInput = document.getElementById(fileInputId);
      const file = fileInput.files[0];
      if (!file) return;

      const formData = new FormData();
      formData.append('image', file);

      const uploadArea = fileInput.closest('.upload-area');
      uploadArea.classList.add('uploading');
      uploadArea.innerHTML = '<p class="upload-progress">Enviando imagem...</p>';

      try {
        const response = await fetch('/admin/api/upload/image', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Erro no upload');

        document.getElementById(hiddenInputId).value = data.url;
        const imgId = hiddenInputId === 'logoUrl' ? 'logoPreviewImg' : 'coverPreviewImg';
        const uploadAreaId = hiddenInputId === 'logoUrl' ? 'logoUploadArea' : 'coverUploadArea';
        showImagePreview(containerId, imgId, uploadAreaId, data.url);

        uploadArea.classList.remove('uploading');
        uploadArea.innerHTML = `
          <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          <p class="upload-text"><strong>Clique para enviar</strong> ou arraste uma imagem</p>
        `;
      } catch (error) {
        uploadArea.classList.remove('uploading');
        uploadArea.innerHTML = `
          <svg class="upload-icon" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"></path></svg>
          <p class="upload-text"><strong>Clique para enviar</strong> ou arraste uma imagem</p>
        `;
        showAlert('Erro ao fazer upload: ' + error.message, 'error');
      }
    }

    let galleryUrls = [];

    function loadGalleryPreviews(galleryString) {
      const container = document.getElementById('galleryPreviewContainer');
      container.innerHTML = '';
      galleryUrls = galleryString ? galleryString.split(',').map(u => u.trim()).filter(u => u) : [];
      
      galleryUrls.forEach((url, index) => {
        const item = document.createElement('div');
        item.className = 'gallery-item';
        item.innerHTML = `
          <img src="${url}" alt="Foto ${index + 1}">
          <button type="button" class="remove-btn" onclick="removeGalleryImage(${index})">&times;</button>
        `;
        container.appendChild(item);
      });

      updateGalleryHiddenInput();
    }

    function updateGalleryHiddenInput() {
      document.getElementById('gallery').value = galleryUrls.join(', ');
    }

    function removeGalleryImage(index) {
      galleryUrls.splice(index, 1);
      loadGalleryPreviews(galleryUrls.join(', '));
    }

    async function uploadGalleryImages() {
      const fileInput = document.getElementById('galleryFiles');
      const files = fileInput.files;
      if (!files || files.length === 0) return;

      const uploadArea = document.getElementById('galleryUploadArea');
      uploadArea.classList.add('uploading');
      const originalContent = uploadArea.innerHTML;
      uploadArea.innerHTML = '<p class="upload-progress">Enviando imagens...</p>';

      try {
        const formData = new FormData();
        for (let i = 0; i < files.length; i++) {
          formData.append('images', files[i]);
        }

        const response = await fetch('/admin/api/upload/images', {
          method: 'POST',
          body: formData,
        });

        const data = await response.json();
        if (!response.ok) throw new Error(data.error || 'Erro no upload');

        galleryUrls = galleryUrls.concat(data.urls);
        loadGalleryPreviews(galleryUrls.join(', '));

        uploadArea.classList.remove('uploading');
        uploadArea.innerHTML = originalContent;
        fileInput.value = '';
      } catch (error) {
        uploadArea.classList.remove('uploading');
        uploadArea.innerHTML = originalContent;
        showAlert('Erro ao fazer upload: ' + error.message, 'error');
      }
    }

    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = 'alert alert-' + type;
      alert.style.display = 'block';
      window.scrollTo(0, 0);
    }

    document.getElementById('businessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Salvando...';

      try {
        const formData = {
          name: document.getElementById('name').value,
          categoryId: document.getElementById('categoryId').value,
          category: document.getElementById('category').value,
          shortDescription: document.getElementById('shortDescription').value || null,
          description: document.getElementById('description').value || null,
          logoUrl: document.getElementById('logoUrl').value || null,
          coverUrl: document.getElementById('coverUrl').value || null,
          gallery: document.getElementById('gallery').value || null,
          address: document.getElementById('address').value || null,
          neighborhood: document.getElementById('neighborhood').value || null,
          city: document.getElementById('city').value || null,
          hours: document.getElementById('hours').value || null,
          latitude: document.getElementById('latitude').value || null,
          longitude: document.getElementById('longitude').value || null,
          phone: document.getElementById('phone').value || null,
          whatsapp: document.getElementById('whatsapp').value || null,
          website: document.getElementById('website').value || null,
          instagram: document.getElementById('instagram').value || null,
          facebook: document.getElementById('facebook').value || null,
          deliveryUrl: document.getElementById('deliveryUrl').value || null,
          priceRange: document.getElementById('priceRange').value || null,
          rating: document.getElementById('rating').value || null,
          reviews: parseInt(document.getElementById('reviews').value) || 0,
          published: document.getElementById('published').checked,
          featured: document.getElementById('featured').checked,
          delivery: document.getElementById('delivery').checked,
        };

        const url = editId ? `/admin/api/businesses/${editId}` : '/admin/api/businesses';
        const method = editId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erro ao salvar');
        }

        showAlert(data.message || 'Empresa salva com sucesso!', 'success');
        setTimeout(() => window.location.href = '/admin/empresas', 1500);
      } catch (error) {
        showAlert(error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Salvar';
      }
    });

    async function logout() {
      await fetch('/admin/api/logout', { method: 'POST' });
      window.location.href = '/admin';
    }
  </script>
</body>
</html>
