<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Empresa - Admin Portal do Romeiro</title>
  <style>
    :root {
      --primary: #b22226;
      --primary-dark: #8b1a1d;
      --sidebar-bg: #1a1a2e;
      --text-light: #e5e7eb;
      --text-muted: #9ca3af;
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: #f8f9fa;
      min-height: 100vh;
      display: flex;
    }
    .sidebar {
      width: 260px;
      background: var(--sidebar-bg);
      color: var(--text-light);
      position: fixed;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    .sidebar-header {
      padding: 24px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
    }
    .sidebar-header h1 {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    .sidebar-header p {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 4px;
    }
    .sidebar nav {
      flex: 1;
      overflow-y: auto;
      padding: 16px 0;
    }
    .nav-section {
      padding: 0 16px;
      margin-bottom: 16px;
    }
    .nav-section-title {
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 8px;
      margin-bottom: 8px;
    }
    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 16px;
      color: var(--text-muted);
      text-decoration: none;
      border-radius: 8px;
      margin-bottom: 4px;
      transition: all 0.2s;
    }
    .nav-item:hover { background: #16213e; color: white; }
    .nav-item.active { background: var(--primary); color: white; }
    .sidebar-footer {
      margin-top: auto;
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
      flex-shrink: 0;
    }
    .logout-btn {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 16px;
      color: #ef4444;
      text-decoration: none;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s;
    }
    .logout-btn:hover { background: rgba(239, 68, 68, 0.1); }
    .main {
      flex: 1;
      margin-left: 260px;
      padding: 32px;
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }
    .header h2 { font-size: 24px; color: #1f2937; }
    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .btn-primary { background: var(--primary); color: white; }
    .btn-primary:hover { background: var(--primary-dark); }
    .btn-secondary { background: #e5e7eb; color: #374151; }
    .btn-secondary:hover { background: #d1d5db; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    .form-container {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      padding: 32px;
    }
    .form-section {
      margin-bottom: 32px;
      padding-bottom: 24px;
      border-bottom: 1px solid #e5e7eb;
    }
    .form-section:last-child {
      margin-bottom: 0;
      padding-bottom: 0;
      border-bottom: none;
    }
    .form-section-title {
      font-size: 16px;
      font-weight: 600;
      color: #1f2937;
      margin-bottom: 16px;
    }
    .form-row {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }
    .form-row-3 {
      grid-template-columns: repeat(3, 1fr);
    }
    .form-group {
      margin-bottom: 16px;
    }
    .form-group.full-width {
      grid-column: span 2;
    }
    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      color: #374151;
      margin-bottom: 6px;
    }
    .form-group input, .form-group textarea, .form-group select {
      width: 100%;
      padding: 10px 12px;
      border: 1px solid #d1d5db;
      border-radius: 8px;
      font-size: 14px;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(178, 34, 38, 0.1);
    }
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    .checkbox-group {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .checkbox-group input[type="checkbox"] {
      width: 18px;
      height: 18px;
      accent-color: var(--primary);
    }
    .form-actions {
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid #e5e7eb;
    }
    .alert {
      padding: 12px 16px;
      border-radius: 8px;
      margin-bottom: 16px;
    }
    .alert-error { background: #fee2e2; color: #b91c1c; }
    .alert-success { background: #d1fae5; color: #059669; }
    .help-text {
      font-size: 12px;
      color: #6b7280;
      margin-top: 4px;
    }
    .image-preview {
      width: 100px;
      height: 100px;
      border-radius: 8px;
      object-fit: cover;
      margin-top: 8px;
      display: none;
    }
    .image-preview.visible { display: block; }
  </style>
</head>
<body>
  <aside class="sidebar">
    <div class="sidebar-header">
      <h1>Portal do Romeiro</h1>
      <p>Painel Administrativo</p>
    </div>
    <nav>
      <div class="nav-section">
        <div class="nav-section-title">Principal</div>
        <a href="/admin/dashboard" class="nav-item">Dashboard</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Conteudo</div>
        <a href="/admin/noticias" class="nav-item">Noticias</a>
        <a href="/admin/videos" class="nav-item">Videos</a>
        <a href="/admin/paginas" class="nav-item">Paginas</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Turismo</div>
        <a href="/admin/pontos-turisticos" class="nav-item">Pontos Turisticos</a>
        <a href="/admin/empresas" class="nav-item active">Guia Comercial</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Romeiro</div>
        <a href="/admin/telefones" class="nav-item">Telefones Uteis</a>
        <a href="/admin/dicas" class="nav-item">Dicas do Romeiro</a>
        <a href="/admin/servicos" class="nav-item">Servicos</a>
      </div>
      <div class="nav-section">
        <div class="nav-section-title">Sistema</div>
        <a href="/admin/usuarios" class="nav-item">Usuarios</a>
      </div>
    </nav>
    <div class="sidebar-footer">
      <a href="#" class="logout-btn" onclick="logout()">Sair</a>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <h2 id="pageTitle">Nova Empresa</h2>
    </div>

    <div class="form-container">
      <div id="alert" class="alert" style="display: none;"></div>

      <form id="businessForm">
        <div class="form-section">
          <h3 class="form-section-title">Informacoes Basicas</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="name">Nome da Empresa *</label>
              <input type="text" id="name" name="name" required>
            </div>
            <div class="form-group">
              <label for="categoryId">Categoria *</label>
              <select id="categoryId" name="categoryId" required onchange="updateCategoryName()">
                <option value="">Selecione...</option>
                <option value="onde-comer" data-name="Restaurante">Onde Comer</option>
                <option value="onde-ficar" data-name="Hospedagem">Onde Ficar</option>
                <option value="onde-comprar" data-name="Loja">Onde Comprar</option>
                <option value="construcao" data-name="Construcao">Construcao e Reforma</option>
                <option value="diversao" data-name="Lazer">Diversao e Lazer</option>
                <option value="carro" data-name="Automotivo">Para seu Carro</option>
                <option value="moto" data-name="Moto">Para sua Moto</option>
              </select>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="category">Tipo de Negocio *</label>
              <input type="text" id="category" name="category" placeholder="Ex: Restaurante, Pousada, Loja..." required>
            </div>
            <div class="form-group">
              <label for="priceRange">Faixa de Preco</label>
              <select id="priceRange" name="priceRange">
                <option value="">Selecione...</option>
                <option value="$">$ - Economico</option>
                <option value="$$">$$ - Moderado</option>
                <option value="$$$">$$$ - Caro</option>
                <option value="$$$$">$$$$ - Luxo</option>
              </select>
            </div>
          </div>
          <div class="form-group">
            <label for="shortDescription">Descricao Curta</label>
            <input type="text" id="shortDescription" name="shortDescription" placeholder="Breve descricao para exibir na listagem">
          </div>
          <div class="form-group">
            <label for="description">Descricao Completa</label>
            <textarea id="description" name="description" placeholder="Descricao detalhada da empresa..."></textarea>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Imagens</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="logoUrl">URL do Logo</label>
              <input type="url" id="logoUrl" name="logoUrl" placeholder="https://..." onchange="previewImage('logoUrl', 'logoPreview')">
              <img id="logoPreview" class="image-preview" alt="Preview">
            </div>
            <div class="form-group">
              <label for="coverUrl">URL da Capa</label>
              <input type="url" id="coverUrl" name="coverUrl" placeholder="https://..." onchange="previewImage('coverUrl', 'coverPreview')">
              <img id="coverPreview" class="image-preview" alt="Preview">
            </div>
          </div>
          <div class="form-group">
            <label for="gallery">Galeria de Fotos</label>
            <textarea id="gallery" name="gallery" placeholder="URLs das imagens separadas por virgula"></textarea>
            <p class="help-text">Insira as URLs das imagens separadas por virgula. Ex: https://img1.jpg, https://img2.jpg</p>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Endereco e Localizacao</h3>
          <div class="form-group">
            <label for="address">Endereco</label>
            <input type="text" id="address" name="address" placeholder="Rua, numero...">
          </div>
          <div class="form-row form-row-3">
            <div class="form-group">
              <label for="neighborhood">Bairro</label>
              <input type="text" id="neighborhood" name="neighborhood">
            </div>
            <div class="form-group">
              <label for="city">Cidade</label>
              <input type="text" id="city" name="city" value="Trindade">
            </div>
            <div class="form-group">
              <label for="hours">Horario de Funcionamento</label>
              <input type="text" id="hours" name="hours" placeholder="Ex: Seg-Sex: 8h-18h">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="latitude">Latitude</label>
              <input type="text" id="latitude" name="latitude" placeholder="-16.6499">
            </div>
            <div class="form-group">
              <label for="longitude">Longitude</label>
              <input type="text" id="longitude" name="longitude" placeholder="-49.4897">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Contato e Redes Sociais</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="phone">Telefone</label>
              <input type="tel" id="phone" name="phone" placeholder="(62) 3333-1234">
            </div>
            <div class="form-group">
              <label for="whatsapp">WhatsApp</label>
              <input type="text" id="whatsapp" name="whatsapp" placeholder="5562999991234">
              <p class="help-text">Numero completo com codigo do pais, sem espacos ou caracteres</p>
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="website">Website</label>
              <input type="url" id="website" name="website" placeholder="https://...">
            </div>
            <div class="form-group">
              <label for="instagram">Instagram</label>
              <input type="text" id="instagram" name="instagram" placeholder="@usuario">
            </div>
          </div>
          <div class="form-row">
            <div class="form-group">
              <label for="facebook">Facebook</label>
              <input type="text" id="facebook" name="facebook" placeholder="nomedapagina">
            </div>
            <div class="form-group">
              <label for="deliveryUrl">Link do Delivery</label>
              <input type="url" id="deliveryUrl" name="deliveryUrl" placeholder="https://ifood.com.br/...">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Avaliacao</h3>
          <div class="form-row">
            <div class="form-group">
              <label for="rating">Nota (0-5)</label>
              <input type="number" id="rating" name="rating" min="0" max="5" step="0.1" placeholder="4.5">
            </div>
            <div class="form-group">
              <label for="reviews">Numero de Avaliacoes</label>
              <input type="number" id="reviews" name="reviews" min="0" placeholder="0">
            </div>
          </div>
        </div>

        <div class="form-section">
          <h3 class="form-section-title">Opcoes</h3>
          <div class="form-row">
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="published" name="published" checked>
                <label for="published">Publicado</label>
              </div>
            </div>
            <div class="form-group">
              <div class="checkbox-group">
                <input type="checkbox" id="featured" name="featured">
                <label for="featured">Empresa em Destaque</label>
              </div>
            </div>
          </div>
          <div class="form-group">
            <div class="checkbox-group">
              <input type="checkbox" id="delivery" name="delivery">
              <label for="delivery">Possui Delivery</label>
            </div>
          </div>
        </div>

        <div class="form-actions">
          <a href="/admin/empresas" class="btn btn-secondary">Cancelar</a>
          <button type="submit" class="btn btn-primary" id="submitBtn">Salvar</button>
        </div>
      </form>
    </div>
  </main>

  <script>
    let editId = null;
    const pathParts = window.location.pathname.split('/');
    if (pathParts.includes('editar') && pathParts[pathParts.length - 1]) {
      editId = pathParts[pathParts.length - 1];
      document.getElementById('pageTitle').textContent = 'Editar Empresa';
      loadBusiness(editId);
    }

    async function loadBusiness(id) {
      try {
        const response = await fetch(`/admin/api/businesses/${id}`);
        if (!response.ok) throw new Error('Empresa nao encontrada');
        const data = await response.json();
        const b = data.business;

        document.getElementById('name').value = b.name || '';
        document.getElementById('categoryId').value = b.categoryId || '';
        document.getElementById('category').value = b.category || '';
        document.getElementById('shortDescription').value = b.shortDescription || '';
        document.getElementById('description').value = b.description || '';
        document.getElementById('logoUrl').value = b.logoUrl || '';
        document.getElementById('coverUrl').value = b.coverUrl || '';
        document.getElementById('gallery').value = b.gallery || '';
        document.getElementById('address').value = b.address || '';
        document.getElementById('neighborhood').value = b.neighborhood || '';
        document.getElementById('city').value = b.city || '';
        document.getElementById('hours').value = b.hours || '';
        document.getElementById('latitude').value = b.latitude || '';
        document.getElementById('longitude').value = b.longitude || '';
        document.getElementById('phone').value = b.phone || '';
        document.getElementById('whatsapp').value = b.whatsapp || '';
        document.getElementById('website').value = b.website || '';
        document.getElementById('instagram').value = b.instagram || '';
        document.getElementById('facebook').value = b.facebook || '';
        document.getElementById('deliveryUrl').value = b.deliveryUrl || '';
        document.getElementById('priceRange').value = b.priceRange || '';
        document.getElementById('rating').value = b.rating || '';
        document.getElementById('reviews').value = b.reviews || 0;
        document.getElementById('published').checked = b.published !== false;
        document.getElementById('featured').checked = b.featured === true;
        document.getElementById('delivery').checked = b.delivery === true;

        previewImage('logoUrl', 'logoPreview');
        previewImage('coverUrl', 'coverPreview');
      } catch (error) {
        showAlert('Erro ao carregar empresa: ' + error.message, 'error');
      }
    }

    function updateCategoryName() {
      const select = document.getElementById('categoryId');
      const selected = select.options[select.selectedIndex];
      const categoryInput = document.getElementById('category');
      if (selected && selected.dataset.name && !categoryInput.value) {
        categoryInput.value = selected.dataset.name;
      }
    }

    function previewImage(inputId, previewId) {
      const url = document.getElementById(inputId).value;
      const preview = document.getElementById(previewId);
      if (url) {
        preview.src = url;
        preview.classList.add('visible');
      } else {
        preview.classList.remove('visible');
      }
    }

    function showAlert(message, type) {
      const alert = document.getElementById('alert');
      alert.textContent = message;
      alert.className = 'alert alert-' + type;
      alert.style.display = 'block';
      window.scrollTo(0, 0);
    }

    document.getElementById('businessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const submitBtn = document.getElementById('submitBtn');
      submitBtn.disabled = true;
      submitBtn.textContent = 'Salvando...';

      try {
        const formData = {
          name: document.getElementById('name').value,
          categoryId: document.getElementById('categoryId').value,
          category: document.getElementById('category').value,
          shortDescription: document.getElementById('shortDescription').value || null,
          description: document.getElementById('description').value || null,
          logoUrl: document.getElementById('logoUrl').value || null,
          coverUrl: document.getElementById('coverUrl').value || null,
          gallery: document.getElementById('gallery').value || null,
          address: document.getElementById('address').value || null,
          neighborhood: document.getElementById('neighborhood').value || null,
          city: document.getElementById('city').value || null,
          hours: document.getElementById('hours').value || null,
          latitude: document.getElementById('latitude').value || null,
          longitude: document.getElementById('longitude').value || null,
          phone: document.getElementById('phone').value || null,
          whatsapp: document.getElementById('whatsapp').value || null,
          website: document.getElementById('website').value || null,
          instagram: document.getElementById('instagram').value || null,
          facebook: document.getElementById('facebook').value || null,
          deliveryUrl: document.getElementById('deliveryUrl').value || null,
          priceRange: document.getElementById('priceRange').value || null,
          rating: document.getElementById('rating').value || null,
          reviews: parseInt(document.getElementById('reviews').value) || 0,
          published: document.getElementById('published').checked,
          featured: document.getElementById('featured').checked,
          delivery: document.getElementById('delivery').checked,
        };

        const url = editId ? `/admin/api/businesses/${editId}` : '/admin/api/businesses';
        const method = editId ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData),
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error || 'Erro ao salvar');
        }

        showAlert(data.message || 'Empresa salva com sucesso!', 'success');
        setTimeout(() => window.location.href = '/admin/empresas', 1500);
      } catch (error) {
        showAlert(error.message, 'error');
        submitBtn.disabled = false;
        submitBtn.textContent = 'Salvar';
      }
    });

    async function logout() {
      await fetch('/admin/api/logout', { method: 'POST' });
      window.location.href = '/admin';
    }
  </script>
</body>
</html>
