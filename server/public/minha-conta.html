<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Minha Conta - Portal do Romeiro</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; background: #f5f5f7; min-height: 100vh; }
    
    .header { background: linear-gradient(135deg, #b22226 0%, #8b1a1d 100%); color: white; padding: 20px; text-align: center; }
    .header h1 { font-size: 1.5rem; font-weight: 600; }
    .header a { color: rgba(255,255,255,0.8); text-decoration: none; font-size: 0.875rem; display: block; margin-top: 8px; }
    
    .container { max-width: 800px; margin: 0 auto; padding: 24px; }
    
    .card { background: white; border-radius: 16px; padding: 24px; margin-bottom: 24px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); }
    .card-title { font-size: 1.125rem; font-weight: 600; color: #1f2937; margin-bottom: 16px; display: flex; align-items: center; gap: 8px; }
    
    .tabs { display: flex; gap: 8px; margin-bottom: 24px; flex-wrap: wrap; }
    .tab { padding: 10px 20px; background: white; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.875rem; font-weight: 500; cursor: pointer; transition: all 0.2s; }
    .tab.active { background: #b22226; color: white; border-color: #b22226; }
    .tab:hover:not(.active) { border-color: #b22226; color: #b22226; }
    
    .listing-grid { display: grid; gap: 16px; }
    .listing-item { background: #f9fafb; border-radius: 12px; padding: 16px; display: flex; align-items: center; gap: 16px; cursor: pointer; transition: all 0.2s; border: 2px solid transparent; }
    .listing-item:hover { border-color: #b22226; background: white; }
    .listing-logo { width: 60px; height: 60px; border-radius: 8px; background: #e5e7eb; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; }
    .listing-logo img { width: 100%; height: 100%; object-fit: cover; }
    .listing-logo svg { width: 24px; height: 24px; color: #9ca3af; }
    .listing-info { flex: 1; min-width: 0; }
    .listing-name { font-weight: 600; color: #1f2937; margin-bottom: 4px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
    .listing-type { font-size: 0.75rem; color: #6b7280; }
    .listing-status { display: flex; gap: 8px; align-items: center; flex-shrink: 0; }
    
    .status-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 10px; border-radius: 20px; font-size: 0.7rem; font-weight: 600; }
    .status-published { background: rgba(16, 185, 129, 0.1); color: #059669; }
    .status-pending { background: rgba(245, 158, 11, 0.1); color: #d97706; }
    .status-unpublished { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
    
    .empty-state { text-align: center; padding: 40px 20px; color: #6b7280; }
    .empty-state svg { width: 48px; height: 48px; margin-bottom: 16px; color: #d1d5db; }
    .empty-state p { margin-bottom: 16px; }
    
    .form-group { margin-bottom: 16px; }
    .form-group label { display: block; font-size: 0.875rem; font-weight: 500; color: #374151; margin-bottom: 6px; }
    .form-group input, .form-group textarea, .form-group select { width: 100%; padding: 12px; border: 1px solid #d1d5db; border-radius: 8px; font-size: 1rem; font-family: inherit; }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus { outline: none; border-color: #b22226; }
    .form-group textarea { resize: vertical; min-height: 100px; }
    .form-group .hint { font-size: 0.75rem; color: #6b7280; margin-top: 4px; }
    
    .btn { display: inline-flex; align-items: center; justify-content: center; gap: 8px; padding: 12px 24px; background: #b22226; color: white; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: background 0.2s; }
    .btn:hover { background: #8b1a1d; }
    .btn:disabled { background: #9ca3af; cursor: not-allowed; }
    .btn-full { width: 100%; }
    .btn-outline { background: transparent; border: 2px solid #b22226; color: #b22226; }
    .btn-outline:hover { background: rgba(178, 34, 38, 0.1); }
    .btn-secondary { background: #4169E1; }
    .btn-secondary:hover { background: #3358c4; }
    .btn-small { padding: 8px 16px; font-size: 0.8rem; }
    
    .btn-group { display: flex; gap: 12px; flex-wrap: wrap; }
    
    .alert { padding: 12px 16px; border-radius: 8px; margin-bottom: 16px; font-size: 0.875rem; }
    .alert-success { background: rgba(16, 185, 129, 0.1); color: #059669; }
    .alert-error { background: rgba(239, 68, 68, 0.1); color: #dc2626; }
    
    .login-container { display: flex; align-items: center; justify-content: center; min-height: calc(100vh - 100px); }
    
    .logo-preview { width: 80px; height: 80px; border-radius: 12px; background: #f3f4f6; display: flex; align-items: center; justify-content: center; overflow: hidden; margin-bottom: 12px; }
    .logo-preview img { width: 100%; height: 100%; object-fit: cover; }
    .logo-preview svg { width: 32px; height: 32px; color: #9ca3af; }
    
    .hidden { display: none !important; }
    
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; padding: 24px; }
    .modal { background: white; border-radius: 16px; max-width: 600px; width: 100%; max-height: 90vh; overflow-y: auto; }
    .modal-header { padding: 20px 24px; border-bottom: 1px solid #e5e7eb; display: flex; align-items: center; justify-content: space-between; }
    .modal-header h2 { font-size: 1.125rem; font-weight: 600; }
    .modal-close { background: none; border: none; cursor: pointer; padding: 4px; }
    .modal-close svg { width: 24px; height: 24px; color: #6b7280; }
    .modal-body { padding: 24px; }
    .modal-footer { padding: 16px 24px; border-top: 1px solid #e5e7eb; display: flex; justify-content: flex-end; gap: 12px; }
    
    .plan-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 16px; margin-bottom: 20px; }
    .plan-card { border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.2s; text-align: center; }
    .plan-card.selected { border-color: #b22226; background: rgba(178, 34, 38, 0.05); }
    .plan-card:hover { border-color: #b22226; }
    .plan-card h3 { font-size: 1rem; font-weight: 600; margin-bottom: 8px; }
    .plan-card .price { font-size: 1.5rem; font-weight: 700; color: #b22226; }
    .plan-card .price span { font-size: 0.875rem; font-weight: 400; color: #6b7280; }
    .plan-card p { font-size: 0.75rem; color: #6b7280; margin-top: 8px; }
    
    .back-btn { display: inline-flex; align-items: center; gap: 4px; color: #6b7280; font-size: 0.875rem; cursor: pointer; margin-bottom: 16px; }
    .back-btn:hover { color: #b22226; }
  </style>
</head>
<body>
  <header class="header">
    <h1>Minha Conta</h1>
    <a href="/">Voltar ao Portal do Romeiro</a>
  </header>

  <div class="container">
    <!-- Login Section -->
    <div id="loginSection" class="login-container">
      <div class="card" style="width: 100%; max-width: 400px;">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
          Entrar na minha conta
        </h2>
        <div id="loginError" class="alert alert-error hidden"></div>
        <form id="loginForm">
          <div class="form-group">
            <label for="email">E-mail</label>
            <input type="email" id="email" name="email" required placeholder="seu@email.com">
          </div>
          <div class="form-group">
            <label for="password">Senha</label>
            <input type="password" id="password" name="password" required placeholder="Sua senha">
          </div>
          <button type="submit" class="btn btn-full" id="loginBtn">Entrar</button>
        </form>
        <p style="text-align: center; margin-top: 16px; font-size: 0.875rem; color: #6b7280;">
          Ainda nao tem cadastro? <a href="/cadastro" style="color: #b22226; text-decoration: none; font-weight: 500;">Cadastre seu negocio</a>
        </p>
      </div>
    </div>

    <!-- Dashboard Section -->
    <div id="dashboardSection" class="hidden">
      <div id="alertContainer"></div>

      <!-- User Info -->
      <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px;">
          <div>
            <h2 style="font-size: 1.25rem; font-weight: 600; color: #1f2937;" id="userName">Ol√°!</h2>
            <p style="font-size: 0.875rem; color: #6b7280;" id="userEmail"></p>
          </div>
          <button class="btn btn-outline btn-small" id="logoutBtn">Sair</button>
        </div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="all">Todos</button>
        <button class="tab" data-tab="business">Empresas</button>
        <button class="tab" data-tab="accommodation">Hospedagens</button>
      </div>

      <!-- Listings -->
      <div class="card">
        <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 16px; flex-wrap: wrap; gap: 12px;">
          <h2 class="card-title" style="margin-bottom: 0;">Meus Cadastros</h2>
          <div class="btn-group">
            <button class="btn btn-small btn-secondary" id="addBusinessBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Nova Empresa
            </button>
            <button class="btn btn-small" id="addAccommodationBtn">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
              Nova Hospedagem
            </button>
          </div>
        </div>

        <div id="listingsContainer" class="listing-grid"></div>
        <div id="emptyState" class="empty-state hidden">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>
          <p>Voce ainda nao tem nenhum cadastro.</p>
          <p>Clique em "Nova Empresa" ou "Nova Hospedagem" para comecar.</p>
        </div>
      </div>
    </div>

    <!-- Edit Section -->
    <div id="editSection" class="hidden">
      <div class="back-btn" id="backToList">
        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"></polyline></svg>
        Voltar aos cadastros
      </div>

      <div class="card">
        <h2 class="card-title" id="editTitle">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
          Editar Cadastro
        </h2>

        <div id="editStatusBanner" class="alert" style="margin-bottom: 20px;"></div>

        <form id="editForm">
          <input type="hidden" id="editId">
          <input type="hidden" id="editType">

          <div class="form-group">
            <label>Logo</label>
            <div class="logo-preview" id="editLogoPreview">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>
            </div>
            <input type="file" id="editLogo" name="logo" accept="image/*">
          </div>

          <div class="form-group">
            <label for="editName">Nome</label>
            <input type="text" id="editName" name="name" required>
          </div>

          <div class="form-group">
            <label for="editAddress">Endereco</label>
            <input type="text" id="editAddress" name="address">
          </div>

          <div class="form-group">
            <label for="editPhone">Telefone</label>
            <input type="tel" id="editPhone" name="phone">
          </div>

          <div class="form-group">
            <label for="editWhatsapp">WhatsApp</label>
            <input type="tel" id="editWhatsapp" name="whatsapp">
          </div>

          <div id="editCompleteFields" class="hidden">
            <div class="form-group">
              <label for="editDescription">Descricao</label>
              <textarea id="editDescription" name="description" rows="4"></textarea>
            </div>
            <div class="form-group">
              <label for="editWebsite">Website</label>
              <input type="url" id="editWebsite" name="website" placeholder="https://">
            </div>
            <div class="form-group">
              <label for="editInstagram">Instagram</label>
              <input type="text" id="editInstagram" name="instagram" placeholder="@seuinstagram">
            </div>
            <div class="form-group" id="editFacebookField">
              <label for="editFacebook">Facebook</label>
              <input type="text" id="editFacebook" name="facebook">
            </div>
            <div class="form-group" id="editHoursField">
              <label for="editHours">Horario de Funcionamento</label>
              <input type="text" id="editHours" name="hours" placeholder="Ex: Seg-Sex 08:00-18:00">
            </div>
            <div class="form-group" id="editEmailField">
              <label for="editEmailBusiness">E-mail comercial</label>
              <input type="email" id="editEmailBusiness" name="email">
            </div>
            <div class="form-group" id="editCheckInField">
              <label for="editCheckInTime">Horario de Check-in</label>
              <input type="time" id="editCheckInTime" name="checkInTime" value="14:00">
            </div>
            <div class="form-group" id="editCheckOutField">
              <label for="editCheckOutTime">Horario de Check-out</label>
              <input type="time" id="editCheckOutTime" name="checkOutTime" value="12:00">
            </div>
          </div>

          <button type="submit" class="btn btn-full" id="editSaveBtn">Salvar Alteracoes</button>
        </form>
      </div>
    </div>
  </div>

  <!-- New Business Modal -->
  <div id="businessModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2>Nova Empresa</h2>
        <button class="modal-close" onclick="closeModal('businessModal')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <form id="businessForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Escolha o Plano</label>
            <div class="plan-cards">
              <div class="plan-card selected" data-plan="basic">
                <h3>Plano Basico</h3>
                <div class="price">Gratis</div>
                <p>Nome e endereco no guia comercial</p>
              </div>
              <div class="plan-card" data-plan="complete">
                <h3>Plano Completo</h3>
                <div class="price">R$ 99<span>/ano</span></div>
                <p>Descricao, fotos, redes sociais e destaque</p>
              </div>
            </div>
            <input type="hidden" id="businessPlan" name="plan" value="basic">
          </div>

          <div class="form-group">
            <label for="businessName">Nome da Empresa *</label>
            <input type="text" id="businessName" name="name" required>
          </div>

          <div class="form-group">
            <label for="businessCategory">Categoria *</label>
            <select id="businessCategory" name="category" required>
              <option value="">Selecione...</option>
              <option value="restaurantes">Restaurantes</option>
              <option value="hoteis">Hoteis e Pousadas</option>
              <option value="comercio">Comercio</option>
              <option value="servicos">Servicos</option>
              <option value="saude">Saude</option>
              <option value="educacao">Educacao</option>
              <option value="lazer">Lazer</option>
              <option value="outros">Outros</option>
            </select>
          </div>

          <div class="form-group">
            <label for="businessAddress">Endereco</label>
            <input type="text" id="businessAddress" name="address">
          </div>

          <div class="form-group">
            <label for="businessWhatsapp">WhatsApp</label>
            <input type="tel" id="businessWhatsapp" name="whatsapp">
          </div>

          <div class="form-group">
            <label>Logo</label>
            <input type="file" id="businessLogo" name="logo" accept="image/*">
          </div>

          <div id="businessCompleteFields" class="hidden">
            <div class="form-group">
              <label for="businessDescription">Descricao</label>
              <textarea id="businessDescription" name="description" rows="3"></textarea>
            </div>
            <div class="form-group">
              <label for="businessWebsite">Website</label>
              <input type="url" id="businessWebsite" name="website" placeholder="https://">
            </div>
            <div class="form-group">
              <label for="businessInstagram">Instagram</label>
              <input type="text" id="businessInstagram" name="instagram" placeholder="@seuinstagram">
            </div>
            <div class="form-group">
              <label for="businessHours">Horario de Funcionamento</label>
              <input type="text" id="businessHours" name="hours" placeholder="Ex: Seg-Sex 08:00-18:00">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="closeModal('businessModal')">Cancelar</button>
          <button type="submit" class="btn" id="businessSubmitBtn">Cadastrar Empresa</button>
        </div>
      </form>
    </div>
  </div>

  <!-- New Accommodation Modal -->
  <div id="accommodationModal" class="modal-overlay hidden">
    <div class="modal">
      <div class="modal-header">
        <h2>Nova Hospedagem</h2>
        <button class="modal-close" onclick="closeModal('accommodationModal')">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>
        </button>
      </div>
      <form id="accommodationForm">
        <div class="modal-body">
          <div class="form-group">
            <label>Escolha o Plano</label>
            <div class="plan-cards" id="accommodationPlanCards">
              <div class="plan-card selected" data-plan="basic">
                <h3>Plano Basico</h3>
                <div class="price">Gratis</div>
                <p>Nome e endereco no guia de hospedagens</p>
              </div>
              <div class="plan-card" data-plan="complete">
                <h3>Plano Completo</h3>
                <div class="price">R$ 149<span>/ano</span></div>
                <p>Descricao, fotos, comodidades e destaque</p>
              </div>
            </div>
            <input type="hidden" id="accommodationPlan" name="plan" value="basic">
          </div>

          <div class="form-group">
            <label for="accommodationType">Tipo de Hospedagem *</label>
            <select id="accommodationType" name="accommodation_type" required>
              <option value="">Selecione...</option>
              <option value="hotel">Hotel</option>
              <option value="pousada">Pousada</option>
              <option value="hostel">Hostel</option>
              <option value="casa">Casa de Temporada</option>
            </select>
          </div>

          <div class="form-group">
            <label for="accommodationName">Nome *</label>
            <input type="text" id="accommodationName" name="name" required>
          </div>

          <div class="form-group">
            <label for="accommodationAddress">Endereco</label>
            <input type="text" id="accommodationAddress" name="address">
          </div>

          <div class="form-group">
            <label for="accommodationPhone">Telefone</label>
            <input type="tel" id="accommodationPhone" name="phone">
          </div>

          <div class="form-group">
            <label for="accommodationWhatsapp">WhatsApp</label>
            <input type="tel" id="accommodationWhatsapp" name="whatsapp">
          </div>

          <div class="form-group">
            <label for="accommodationEmail">E-mail</label>
            <input type="email" id="accommodationEmail" name="email">
          </div>

          <div class="form-group">
            <label>Logo</label>
            <input type="file" id="accommodationLogo" name="logo" accept="image/*">
          </div>

          <div id="accommodationCompleteFields" class="hidden">
            <div class="form-group">
              <label for="accommodationDescription">Descricao</label>
              <textarea id="accommodationDescription" name="description" rows="3"></textarea>
            </div>

            <div class="form-group">
              <label for="accommodationWebsite">Website</label>
              <input type="url" id="accommodationWebsite" name="website" placeholder="https://">
            </div>

            <div class="form-group">
              <label for="accommodationInstagram">Instagram</label>
              <input type="text" id="accommodationInstagram" name="instagram" placeholder="@seuinstagram">
            </div>

            <div class="form-group">
              <label for="accommodationCheckIn">Horario de Check-in</label>
              <input type="time" id="accommodationCheckIn" name="checkInTime" value="14:00">
            </div>

            <div class="form-group">
              <label for="accommodationCheckOut">Horario de Check-out</label>
              <input type="time" id="accommodationCheckOut" name="checkOutTime" value="12:00">
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-outline" onclick="closeModal('accommodationModal')">Cancelar</button>
          <button type="submit" class="btn" id="accommodationSubmitBtn">Cadastrar Hospedagem</button>
        </div>
      </form>
    </div>
  </div>

  <script>
    let currentOwner = null;
    let listings = [];
    let currentTab = 'all';
    let editingListing = null;

    async function checkAuth() {
      try {
        const response = await fetch('/api/owner/me');
        if (response.ok) {
          const data = await response.json();
          currentOwner = data.owner;
          showDashboard();
          loadListings();
        }
      } catch (error) {
        console.error('Auth check error:', error);
      }
    }

    function showDashboard() {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('dashboardSection').classList.remove('hidden');
      document.getElementById('editSection').classList.add('hidden');
      
      document.getElementById('userName').textContent = 'Ola, ' + (currentOwner?.name || 'Usuario') + '!';
      document.getElementById('userEmail').textContent = currentOwner?.email || '';
    }

    function showLogin() {
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('dashboardSection').classList.add('hidden');
      document.getElementById('editSection').classList.add('hidden');
    }

    function showEdit(listing, type) {
      editingListing = { ...listing, listingType: type };
      document.getElementById('dashboardSection').classList.add('hidden');
      document.getElementById('editSection').classList.remove('hidden');
      
      document.getElementById('editId').value = listing.id;
      document.getElementById('editType').value = type;
      document.getElementById('editTitle').innerHTML = `
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
        Editar ${type === 'business' ? 'Empresa' : 'Hospedagem'}
      `;

      // Status banner
      const banner = document.getElementById('editStatusBanner');
      if (listing.published) {
        banner.className = 'alert alert-success';
        banner.textContent = 'Este cadastro esta publicado e visivel no aplicativo.';
      } else {
        banner.className = 'alert alert-error';
        banner.textContent = 'Este cadastro esta aguardando aprovacao do administrador.';
      }

      // Fill form
      document.getElementById('editName').value = listing.name || '';
      document.getElementById('editAddress').value = listing.address || '';
      document.getElementById('editPhone').value = listing.phone || '';
      document.getElementById('editWhatsapp').value = listing.whatsapp || '';

      if (listing.logoUrl) {
        document.getElementById('editLogoPreview').innerHTML = `<img src="${listing.logoUrl}" alt="Logo">`;
      } else {
        document.getElementById('editLogoPreview').innerHTML = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect><circle cx="8.5" cy="8.5" r="1.5"></circle><polyline points="21 15 16 10 5 21"></polyline></svg>`;
      }

      const isComplete = type === 'accommodation' || listing.planType === 'complete';

      if (isComplete) {
        document.getElementById('editCompleteFields').classList.remove('hidden');
        document.getElementById('editDescription').value = listing.description || '';
        document.getElementById('editWebsite').value = listing.website || '';
        document.getElementById('editInstagram').value = listing.instagram || '';

        if (type === 'business') {
          document.getElementById('editFacebookField').classList.remove('hidden');
          document.getElementById('editHoursField').classList.remove('hidden');
          document.getElementById('editEmailField').classList.add('hidden');
          document.getElementById('editCheckInField').classList.add('hidden');
          document.getElementById('editCheckOutField').classList.add('hidden');
          document.getElementById('editFacebook').value = listing.facebook || '';
          document.getElementById('editHours').value = listing.hours || '';
        } else {
          document.getElementById('editFacebookField').classList.add('hidden');
          document.getElementById('editHoursField').classList.add('hidden');
          document.getElementById('editEmailField').classList.remove('hidden');
          document.getElementById('editCheckInField').classList.remove('hidden');
          document.getElementById('editCheckOutField').classList.remove('hidden');
          document.getElementById('editEmailBusiness').value = listing.email || '';
          document.getElementById('editCheckInTime').value = listing.checkInTime || '14:00';
          document.getElementById('editCheckOutTime').value = listing.checkOutTime || '12:00';
        }
      } else {
        document.getElementById('editCompleteFields').classList.add('hidden');
      }
    }

    async function loadListings() {
      try {
        const url = currentTab === 'all' ? '/api/owner/listings' : `/api/owner/listings?type=${currentTab}`;
        const response = await fetch(url);
        if (response.ok) {
          const data = await response.json();
          listings = data.listings || [];
          renderListings();
        }
      } catch (error) {
        console.error('Load listings error:', error);
      }
    }

    function renderListings() {
      const container = document.getElementById('listingsContainer');
      const emptyState = document.getElementById('emptyState');

      if (listings.length === 0) {
        container.innerHTML = '';
        emptyState.classList.remove('hidden');
        return;
      }

      emptyState.classList.add('hidden');
      container.innerHTML = listings.map(listing => {
        const isBusiness = listing.listingType === 'business';
        const typeLabel = isBusiness ? (listing.category || 'Empresa') : (listing.type || 'Hospedagem');
        const statusClass = listing.published ? 'status-published' : 'status-pending';
        const statusText = listing.published ? 'Publicado' : 'Pendente';

        return `
          <div class="listing-item" onclick="showEdit(${JSON.stringify(listing).replace(/"/g, '&quot;')}, '${listing.listingType}')">
            <div class="listing-logo">
              ${listing.logoUrl ? `<img src="${listing.logoUrl}" alt="${listing.name}">` : `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>`}
            </div>
            <div class="listing-info">
              <div class="listing-name">${listing.name}</div>
              <div class="listing-type">${isBusiness ? 'Empresa' : 'Hospedagem'} - ${typeLabel}</div>
            </div>
            <div class="listing-status">
              <span class="status-badge ${statusClass}">${statusText}</span>
            </div>
          </div>
        `;
      }).join('');
    }

    function showAlert(message, type = 'success') {
      const container = document.getElementById('alertContainer');
      container.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
      setTimeout(() => container.innerHTML = '', 5000);
    }

    function closeModal(modalId) {
      document.getElementById(modalId).classList.add('hidden');
    }

    function openModal(modalId) {
      document.getElementById(modalId).classList.remove('hidden');
    }

    // Login form
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('loginBtn');
      const errorDiv = document.getElementById('loginError');
      
      btn.disabled = true;
      btn.textContent = 'Entrando...';
      errorDiv.classList.add('hidden');

      try {
        const response = await fetch('/api/owner/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email: document.getElementById('email').value,
            password: document.getElementById('password').value
          })
        });

        const data = await response.json();

        if (response.ok) {
          currentOwner = data.owner;
          showDashboard();
          loadListings();
        } else {
          errorDiv.textContent = data.error || 'Erro ao fazer login';
          errorDiv.classList.remove('hidden');
        }
      } catch (error) {
        errorDiv.textContent = 'Erro de conexao. Tente novamente.';
        errorDiv.classList.remove('hidden');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Entrar';
      }
    });

    // Logout
    document.getElementById('logoutBtn').addEventListener('click', async () => {
      try {
        await fetch('/api/owner/logout', { method: 'POST' });
        currentOwner = null;
        listings = [];
        showLogin();
      } catch (error) {
        console.error('Logout error:', error);
      }
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');
        currentTab = tab.dataset.tab;
        loadListings();
      });
    });

    // Back to list
    document.getElementById('backToList').addEventListener('click', () => {
      showDashboard();
      loadListings();
    });

    // Add buttons
    document.getElementById('addBusinessBtn').addEventListener('click', () => openModal('businessModal'));
    document.getElementById('addAccommodationBtn').addEventListener('click', () => openModal('accommodationModal'));

    // Plan cards - Business
    document.querySelectorAll('#businessModal .plan-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('#businessModal .plan-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        document.getElementById('businessPlan').value = card.dataset.plan;
        
        if (card.dataset.plan === 'complete') {
          document.getElementById('businessCompleteFields').classList.remove('hidden');
        } else {
          document.getElementById('businessCompleteFields').classList.add('hidden');
        }
      });
    });

    // Plan cards - Accommodation
    document.querySelectorAll('#accommodationModal .plan-card').forEach(card => {
      card.addEventListener('click', () => {
        document.querySelectorAll('#accommodationModal .plan-card').forEach(c => c.classList.remove('selected'));
        card.classList.add('selected');
        document.getElementById('accommodationPlan').value = card.dataset.plan;
        
        if (card.dataset.plan === 'complete') {
          document.getElementById('accommodationCompleteFields').classList.remove('hidden');
        } else {
          document.getElementById('accommodationCompleteFields').classList.add('hidden');
        }
      });
    });

    // Business form
    document.getElementById('businessForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('businessSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'Cadastrando...';

      try {
        const formData = new FormData();
        formData.append('name', document.getElementById('businessName').value);
        formData.append('category', document.getElementById('businessCategory').value);
        formData.append('address', document.getElementById('businessAddress').value);
        formData.append('whatsapp', document.getElementById('businessWhatsapp').value);
        formData.append('plan', document.getElementById('businessPlan').value);

        const logoInput = document.getElementById('businessLogo');
        if (logoInput.files[0]) {
          formData.append('logo', logoInput.files[0]);
        }

        if (document.getElementById('businessPlan').value === 'complete') {
          formData.append('description', document.getElementById('businessDescription').value);
          formData.append('website', document.getElementById('businessWebsite').value);
          formData.append('instagram', document.getElementById('businessInstagram').value);
          formData.append('hours', document.getElementById('businessHours').value);
        }

        const response = await fetch('/api/owner/listings/business', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          closeModal('businessModal');
          document.getElementById('businessForm').reset();
          document.getElementById('businessCompleteFields').classList.add('hidden');
          document.querySelectorAll('#businessModal .plan-card').forEach(c => c.classList.remove('selected'));
          document.querySelector('#businessModal .plan-card[data-plan="basic"]').classList.add('selected');
          document.getElementById('businessPlan').value = 'basic';
          
          if (data.paymentUrl) {
            showAlert('Cadastro realizado! Voce sera redirecionado para o pagamento...');
            setTimeout(() => {
              window.location.href = data.paymentUrl;
            }, 1500);
          } else if (data.requiresPayment) {
            showAlert('Cadastro realizado! ' + (data.message || 'O pagamento sera processado posteriormente.'));
            loadListings();
          } else {
            showAlert('Empresa cadastrada com sucesso! Aguarde a aprovacao do administrador.');
            loadListings();
          }
        } else {
          alert(data.error || 'Erro ao cadastrar empresa');
        }
      } catch (error) {
        alert('Erro de conexao. Tente novamente.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Cadastrar Empresa';
      }
    });

    // Accommodation form
    document.getElementById('accommodationForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('accommodationSubmitBtn');
      btn.disabled = true;
      btn.textContent = 'Cadastrando...';

      try {
        const formData = new FormData();
        formData.append('name', document.getElementById('accommodationName').value);
        formData.append('accommodation_type', document.getElementById('accommodationType').value);
        formData.append('address', document.getElementById('accommodationAddress').value);
        formData.append('phone', document.getElementById('accommodationPhone').value);
        formData.append('whatsapp', document.getElementById('accommodationWhatsapp').value);
        formData.append('email', document.getElementById('accommodationEmail').value);
        formData.append('plan', document.getElementById('accommodationPlan').value);

        const logoInput = document.getElementById('accommodationLogo');
        if (logoInput.files[0]) {
          formData.append('logo', logoInput.files[0]);
        }

        if (document.getElementById('accommodationPlan').value === 'complete') {
          formData.append('description', document.getElementById('accommodationDescription').value);
          formData.append('website', document.getElementById('accommodationWebsite').value);
          formData.append('instagram', document.getElementById('accommodationInstagram').value);
          formData.append('checkInTime', document.getElementById('accommodationCheckIn').value);
          formData.append('checkOutTime', document.getElementById('accommodationCheckOut').value);
        }

        const response = await fetch('/api/owner/listings/accommodation', {
          method: 'POST',
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          closeModal('accommodationModal');
          document.getElementById('accommodationForm').reset();
          document.getElementById('accommodationCompleteFields').classList.add('hidden');
          document.querySelectorAll('#accommodationModal .plan-card').forEach(c => c.classList.remove('selected'));
          document.querySelector('#accommodationModal .plan-card[data-plan="basic"]').classList.add('selected');
          document.getElementById('accommodationPlan').value = 'basic';
          
          if (data.paymentUrl) {
            showAlert('Cadastro realizado! Voce sera redirecionado para o pagamento...');
            setTimeout(() => {
              window.location.href = data.paymentUrl;
            }, 1500);
          } else if (data.requiresPayment) {
            showAlert('Cadastro realizado! ' + (data.message || 'O pagamento sera processado posteriormente.'));
            loadListings();
          } else {
            showAlert('Hospedagem cadastrada com sucesso! Aguarde a aprovacao do administrador.');
            loadListings();
          }
        } else {
          alert(data.error || 'Erro ao cadastrar hospedagem');
        }
      } catch (error) {
        alert('Erro de conexao. Tente novamente.');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Cadastrar Hospedagem';
      }
    });

    // Edit form
    document.getElementById('editForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const btn = document.getElementById('editSaveBtn');
      btn.disabled = true;
      btn.textContent = 'Salvando...';

      try {
        const formData = new FormData();
        const type = document.getElementById('editType').value;
        const id = document.getElementById('editId').value;

        formData.append('name', document.getElementById('editName').value);
        formData.append('address', document.getElementById('editAddress').value);
        formData.append('phone', document.getElementById('editPhone').value);
        formData.append('whatsapp', document.getElementById('editWhatsapp').value);

        const logoInput = document.getElementById('editLogo');
        if (logoInput.files[0]) {
          formData.append('logo', logoInput.files[0]);
        }

        const isComplete = type === 'accommodation' || editingListing?.planType === 'complete';
        if (isComplete) {
          formData.append('description', document.getElementById('editDescription').value);
          formData.append('website', document.getElementById('editWebsite').value);
          formData.append('instagram', document.getElementById('editInstagram').value);

          if (type === 'business') {
            formData.append('facebook', document.getElementById('editFacebook').value);
            formData.append('hours', document.getElementById('editHours').value);
          } else {
            formData.append('email', document.getElementById('editEmailBusiness').value);
            formData.append('checkInTime', document.getElementById('editCheckInTime').value);
            formData.append('checkOutTime', document.getElementById('editCheckOutTime').value);
          }
        }

        const response = await fetch(`/api/owner/listings/${type}/${id}`, {
          method: 'PUT',
          body: formData
        });

        const data = await response.json();

        if (response.ok) {
          showAlert('Informacoes atualizadas com sucesso!');
          editingListing = data.listing;
          if (data.listing.logoUrl) {
            document.getElementById('editLogoPreview').innerHTML = `<img src="${data.listing.logoUrl}" alt="Logo">`;
          }
        } else {
          showAlert(data.error || 'Erro ao salvar', 'error');
        }
      } catch (error) {
        showAlert('Erro de conexao. Tente novamente.', 'error');
      } finally {
        btn.disabled = false;
        btn.textContent = 'Salvar Alteracoes';
      }
    });

    // Logo preview for edit
    document.getElementById('editLogo').addEventListener('change', (e) => {
      const file = e.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = (e) => {
          document.getElementById('editLogoPreview').innerHTML = `<img src="${e.target.result}" alt="Preview">`;
        };
        reader.readAsDataURL(file);
      }
    });

    // Initialize
    checkAuth();
  </script>
</body>
</html>
